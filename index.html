<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Card Maximizer</title>
  <link rel="manifest" href="manifest.json">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;600&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0a0d14;
      --surface: #11151f;
      --surface2: #181d2a;
      --border: rgba(255,255,255,0.07);
      --border-active: rgba(255,255,255,0.18);
      --gold: #c9a84c;
      --gold-light: #e8c97a;
      --text: #e8eaf0;
      --text-muted: #8892a4;
      --accent: #3d6cdb;
      --accent2: #6b9cff;
      --success: #10b981;
      --warning: #f59e0b;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      overflow-x: hidden;
    }

    /* Ambient background */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background:
        radial-gradient(ellipse 60% 40% at 20% 10%, rgba(61,108,219,0.12) 0%, transparent 60%),
        radial-gradient(ellipse 50% 40% at 80% 80%, rgba(201,168,76,0.08) 0%, transparent 60%);
      pointer-events: none;
      z-index: 0;
    }

    .app {
      position: relative;
      z-index: 1;
      width: 100%;
      max-width: 480px;
    }

    /* Top Bar (Status & Settings) */
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .status-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.75rem;
      color: var(--text-muted);
      background: rgba(255,255,255,0.03);
      padding: 6px 12px;
      border-radius: 20px;
      border: 1px solid var(--border);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
      box-shadow: 0 0 8px var(--success);
    }

    .settings-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 1.2rem;
      cursor: pointer;
      transition: color 0.2s;
    }
    .settings-btn:hover { color: var(--text); }

    /* Monthly Reminder Banner */
    #monthly-reminder {
      display: none;
      justify-content: space-between;
      align-items: center;
      background: rgba(201,168,76,0.1);
      border: 1px solid var(--gold);
      border-radius: 12px;
      padding: 12px 16px;
      margin-bottom: 24px;
      animation: fadeIn 0.4s ease;
    }
    
    .reminder-text {
      font-size: 0.85rem;
      color: var(--gold-light);
      line-height: 1.4;
    }
    
    .reminder-close {
      background: none;
      border: none;
      color: var(--gold);
      font-size: 1.2rem;
      cursor: pointer;
      padding: 0 0 0 12px;
    }

    /* Header */
    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .logo-ring {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--gold), var(--accent));
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 16px;
      font-size: 22px;
      box-shadow: 0 0 32px rgba(201,168,76,0.2), 0 0 0 1px rgba(201,168,76,0.15);
    }

    .header h1 {
      font-family: 'Playfair Display', serif;
      font-size: 1.75rem;
      font-weight: 600;
      letter-spacing: -0.02em;
      background: linear-gradient(135deg, #fff 40%, var(--gold-light));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* Search */
    .search-wrap {
      position: relative;
      margin-bottom: 16px;
    }

    .search-icon {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      font-size: 15px;
      pointer-events: none;
    }

    #category-search {
      width: 100%;
      padding: 16px 16px 16px 44px;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.95rem;
      font-weight: 400;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text);
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    #category-search::placeholder { color: var(--text-muted); }
    #category-search:focus {
      border-color: var(--border-active);
      box-shadow: 0 0 0 3px rgba(61,108,219,0.12);
    }

    /* Quick Tiles with visible scrollbar */
    .quick-tiles {
      display: flex;
      gap: 10px;
      overflow-x: auto;
      padding-bottom: 12px;
      margin-bottom: 16px;
    }

    .quick-tiles::-webkit-scrollbar {
      height: 6px;
    }
    .quick-tiles::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 4px;
    }
    .quick-tiles::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 4px;
    }
    .quick-tiles::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.4);
    }

    .quick-tile {
      background: var(--surface);
      border: 1px solid var(--border);
      padding: 10px 16px;
      border-radius: 20px;
      font-size: 0.85rem;
      color: var(--text);
      white-space: nowrap;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: background 0.2s, border-color 0.2s;
    }
    .quick-tile:hover {
      background: var(--surface2);
      border-color: var(--border-active);
    }

    /* Dropdown */
    .dropdown {
      display: none;
      position: absolute;
      top: calc(100% + 6px);
      left: 0; right: 0;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      max-height: 320px;
      overflow-y: auto;
      z-index: 100;
      box-shadow: 0 24px 60px rgba(0,0,0,0.6);
    }

    .dropdown.show { display: block; }
    .dropdown::-webkit-scrollbar { width: 4px; }
    .dropdown::-webkit-scrollbar-track { background: transparent; }
    .dropdown::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 4px; }

    .option-group {
      padding: 10px 16px 6px;
      font-size: 0.68rem;
      font-weight: 500;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      position: sticky;
      top: 0;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
    }

    .option-item {
      padding: 12px 16px;
      cursor: pointer;
      font-size: 0.9rem;
      color: var(--text);
      transition: background 0.15s;
      display: flex;
      align-items: center;
      gap: 10px;
      border-bottom: 1px solid rgba(255,255,255,0.03);
    }

    .option-item:hover { background: var(--surface2); color: #fff; }

    /* Sub question & Notes */
    #sub-question {
      display: none;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 20px;
      margin-bottom: 16px;
      animation: fadeIn 0.3s ease;
    }

    #sub-question p {
      font-size: 0.82rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--gold);
      font-weight: 500;
      margin-bottom: 14px;
    }

    .sub-btn {
      display: block;
      width: 100%;
      padding: 13px 16px;
      margin-bottom: 8px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 10px;
      cursor: pointer;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.88rem;
      color: var(--text);
      text-align: left;
      transition: all 0.2s;
    }
    .sub-btn:hover { background: var(--accent); border-color: var(--accent); transform: translateX(3px); }

    .note {
      display: none;
      background: rgba(201,168,76,0.08);
      border: 1px solid rgba(201,168,76,0.2);
      border-radius: 10px;
      padding: 14px 16px;
      font-size: 0.83rem;
      color: #d4a843;
      line-height: 1.6;
      margin-bottom: 16px;
      animation: fadeIn 0.3s ease;
    }

    /* Recommendations & Cards */
    .reco-area { display: none; animation: fadeIn 0.3s ease; }

    .reco-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-muted);
      font-weight: 500;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .reco-label::before, .reco-label::after { content: ''; flex: 1; height: 1px; background: var(--border); }

    .cc-card {
      border-radius: 16px;
      padding: 22px 24px;
      margin-bottom: 12px;
      position: relative;
      overflow: hidden;
      cursor: default;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .cc-card:hover { transform: translateY(-2px); box-shadow: 0 16px 40px rgba(0,0,0,0.4); }
    .cc-card::after { content: ''; position: absolute; inset: 0; background: linear-gradient(135deg, rgba(255,255,255,0.08) 0%, transparent 60%); pointer-events: none; }

    .card-rank { position: absolute; top: 14px; right: 18px; font-family: 'Playfair Display', serif; font-size: 2.5rem; font-weight: 600; opacity: 0.12; line-height: 1; }
    .card-name { font-size: 1rem; font-weight: 500; margin-bottom: 6px; }
    .card-perk { font-size: 0.83rem; opacity: 0.8; font-weight: 300; line-height: 1.4; }

    .bg-costco  { background: linear-gradient(135deg, #004e6e 0%, #0077a8 100%); }
    .bg-schwab  { background: linear-gradient(135deg, #2a2e38 0%, #3e4352 100%); border: 1px solid rgba(255,255,255,0.1); }
    .bg-bppr    { background: linear-gradient(135deg, #8b0000 0%, #c0001a 100%); }
    .bg-aa      { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 1px solid rgba(255,255,255,0.08); }
    .bg-onepay  { background: linear-gradient(135deg, #3730a3 0%, #4f46e5 100%); }
    .bg-amazon  { background: linear-gradient(135deg, #13202e 0%, #1e3a5f 100%); }
    .bg-cashplus { background: linear-gradient(135deg, #001a52 0%, #0033a0 100%); }

    /* Settings Modal */
    .modal-overlay {
      display: none;
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(4px);
      z-index: 1000;
      align-items: center; justify-content: center;
    }
    .modal-overlay.active { display: flex; animation: fadeIn 0.2s ease; }

    .modal-content {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      width: 90%; max-width: 400px;
      padding: 24px;
      box-shadow: 0 24px 60px rgba(0,0,0,0.8);
    }
    
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .modal-header h2 { font-size: 1.2rem; font-weight: 500; }
    .close-modal { background: none; border: none; color: var(--text-muted); font-size: 1.2rem; cursor: pointer; }

    .wallet-list { max-height: 50vh; overflow-y: auto; margin-bottom: 20px; padding-right: 8px;}
    .wallet-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 12px 0; border-bottom: 1px solid var(--border);
    }
    .wallet-item:last-child { border-bottom: none; }
    .wallet-item label { font-size: 0.9rem; cursor: pointer; flex: 1; }

    /* Toggle Switch */
    .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider {
      position: absolute; cursor: pointer; inset: 0;
      background-color: var(--surface2); border-radius: 24px; transition: .3s;
      border: 1px solid var(--border);
    }
    .slider:before {
      position: absolute; content: ""; height: 16px; width: 16px;
      left: 3px; bottom: 3px; background-color: var(--text-muted);
      border-radius: 50%; transition: .3s;
    }
    input:checked + .slider { background-color: var(--accent); border-color: var(--accent); }
    input:checked + .slider:before { transform: translateX(20px); background-color: #fff; }

    .save-btn {
      width: 100%; padding: 14px; background: var(--accent); border: none;
      border-radius: 10px; color: #fff; font-family: 'DM Sans', sans-serif;
      font-size: 0.95rem; font-weight: 500; cursor: pointer; transition: background 0.2s;
    }
    .save-btn:hover { background: var(--accent2); }

    .no-cards-msg { text-align: center; color: var(--text-muted); font-size: 0.85rem; padding: 20px; border: 1px dashed var(--border); border-radius: 10px; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>

<div class="app">
  <div class="top-bar">
    <div class="status-badge" id="offline-badge">
      <span class="status-dot"></span> <span id="status-text">Online & Synced</span>
    </div>
    <button class="settings-btn" onclick="openSettings()">âš™ï¸</button>
  </div>

  <div id="monthly-reminder">
    <div class="reminder-text"><strong>ğŸ”” Monthly Activation Reminder</strong><br>Don't forget to select your 5% / 3% categories for U.S. Bank Cash+ and OnePay this month!</div>
    <button class="reminder-close" onclick="dismissReminder()">Ã—</button>
  </div>

  <div class="header">
    <div class="logo-ring">ğŸ’³</div>
    <h1>Card Maximizer</h1>
  </div>

  <div class="search-wrap">
    <span class="search-icon">ğŸ”</span>
    <input type="text" id="category-search" placeholder="Search spending categoryâ€¦" autocomplete="off">
    <div class="dropdown" id="custom-options-list"></div>
  </div>

  <div class="quick-tiles">
    <div class="quick-tile" onclick="triggerQuickTile('gas')">â›½ Gas</div>
    <div class="quick-tile" onclick="triggerQuickTile('dining')">ğŸ½ï¸ Dining</div>
    <div class="quick-tile" onclick="triggerQuickTile('groceries')">ğŸ›’ Groceries</div>
    <div class="quick-tile" onclick="triggerQuickTile('travel')">âœˆï¸ Flights</div>
    <div class="quick-tile" onclick="triggerQuickTile('marina')">ğŸ›¥ï¸ Marina Fuel</div>
  </div>

  <div id="sub-question">
    <p>What's your priority for this rental?</p>
    <button class="sub-btn" onclick="resolveSub('insurance')">ğŸ›¡ï¸ Coverage â€” Primary Insurance up to $1.5M / $75k</button>
    <button class="sub-btn" onclick="resolveSub('discount')">â­ Discounted Rate & Elite Status</button>
    <button class="sub-btn" onclick="resolveSub('cashback')">ğŸ’° Maximize Cash Back</button>
  </div>

  <div id="note-area" class="note"></div>

  <div class="reco-area" id="recommendation-area">
    <div class="reco-label">Top Recommended Cards</div>
    <div id="cards-container"></div>
  </div>
</div>

<div class="modal-overlay" id="settings-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>My Wallet</h2>
      <button class="close-modal" onclick="closeSettings()">âœ•</button>
    </div>
    <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 16px;">Toggle the cards you currently own. Recommendations will update automatically.</p>
    <div class="wallet-list" id="wallet-list-container">
      </div>
    <button class="save-btn" onclick="saveSettings()">Save & Update</button>
  </div>
</div>

<script>
  // Core Data
  const knownCards = [
    "U.S. Bank Cash+", "OnePay", "Amazon Prime Visa", "Citi Costco Anywhere Visa",
    "AMEX Schwab Platinum", "Citi AAdvantage Executive", "BPPR AAdvantage MC Black", "BPPR Visa Infinite"
  ];

  // Load User Wallet from LocalStorage or default to all true
  let userWallet = JSON.parse(localStorage.getItem('userWallet')) || {};
  if (Object.keys(userWallet).length === 0) {
    knownCards.forEach(card => userWallet[card] = true);
  }

  const rulesMap = {
    utilities:       { note: "Quarterly 5% categories cap at $2,000 spend.", cards: [ { name: "U.S. Bank Cash+", perk: "5% cash back (capped) Â· 1% thereafter", color: "bg-cashplus" }, { name: "OnePay", perk: "1.5% flat cash back", color: "bg-onepay" } ] },
    gym:             { cards: [ { name: "U.S. Bank Cash+", perk: "5% cash back (if selected)", color: "bg-cashplus" }, { name: "OnePay", perk: "1.5% flat cash back", color: "bg-onepay" } ] },
    electronics:     { cards: [ { name: "U.S. Bank Cash+", perk: "5% cash back (if selected)", color: "bg-cashplus" }, { name: "Amazon Prime Visa", perk: "5% back when buying on Amazon", color: "bg-amazon" } ] },
    sporting_goods:  { cards: [ { name: "U.S. Bank Cash+", perk: "5% cash back (if selected)", color: "bg-cashplus" }, { name: "OnePay", perk: "1.5% flat cash back", color: "bg-onepay" } ] },
    groceries:       { cards: [ { name: "U.S. Bank Cash+", perk: "2% cash back (if selected)", color: "bg-cashplus" }, { name: "OnePay", perk: "1.5% flat cash back", color: "bg-onepay" } ] },
    fast_food:       { cards: [ { name: "U.S. Bank Cash+", perk: "5% cash back (if selected)", color: "bg-cashplus" }, { name: "Citi Costco Anywhere Visa", perk: "3% cash back", color: "bg-costco" } ] },
    gas:             { cards: [ { name: "Citi Costco Anywhere Visa", perk: "4% cash back (up to $7k/yr)", color: "bg-costco" }, { name: "OnePay", perk: "1.5% flat Â· or 3% as monthly category", color: "bg-onepay" } ] },
    dining:          { cards: [ { name: "Citi Costco Anywhere Visa", perk: "3% cash back", color: "bg-costco" }, { name: "OnePay", perk: "1.5% flat Â· or 3% as monthly category", color: "bg-onepay" } ] },
    travel_airfare:  { cards: [ { name: "AMEX Schwab Platinum", perk: "5Ã— points on flights", color: "bg-schwab" }, { name: "Citi AAdvantage Executive", perk: "4Ã— AA miles on American Airlines", color: "bg-aa" } ] },
    travel_hotel:    { cards: [ { name: "AMEX Schwab Platinum", perk: "5Ã— points on prepaid hotels via Amex Travel", color: "bg-schwab" }, { name: "Citi Costco Anywhere Visa", perk: "3% cash back on travel", color: "bg-costco" } ] },
    travel_other:    { cards: [ { name: "Citi Costco Anywhere Visa", perk: "3% cash back on travel", color: "bg-costco" }, { name: "AMEX Schwab Platinum", perk: "1Ã— points Â· No foreign transaction fees", color: "bg-schwab" } ] },
    travel_car_rental: { requiresSubChoice: true },
    costco:          { cards: [ { name: "Citi Costco Anywhere Visa", perk: "2% cash back at Costco", color: "bg-costco" }, { name: "OnePay", perk: "1.5% flat cash back", color: "bg-onepay" } ] },
    walmart:         { cards: [ { name: "OnePay", perk: "3â€“5% cash back (with Walmart+)", color: "bg-onepay" }, { name: "Citi Costco Anywhere Visa", perk: "1% cash back", color: "bg-costco" } ] },
    marina_fuel:     { note: "âš ï¸ Marina fuel often codes as MCC 5932 (Marinas), not a gas station â€” standard fuel multipliers typically won't apply. A flat-rate card is the safest choice.", cards: [ { name: "OnePay", perk: "1.5% flat cash back on all transactions", color: "bg-onepay" }, { name: "BPPR AAdvantage MC Black", perk: "1Ã— AA mile Â· Builds loyalty status", color: "bg-bppr" } ] },
    marina_fees:     { cards: [ { name: "AMEX Schwab Platinum", perk: "No foreign transaction fees", color: "bg-schwab" }, { name: "OnePay", perk: "1.5% flat cash back", color: "bg-onepay" } ] },
    default:         { cards: [ { name: "OnePay", perk: "1.5% flat cash back", color: "bg-onepay" }, { name: "BPPR AAdvantage MC Black", perk: "1Ã— AA mile on everyday purchases", color: "bg-bppr" } ] }
  };

  const carRentalSubChoices = {
    insurance: [ { name: "BPPR Visa Infinite", perk: "Primary coverage up to 31 days (decline CDW/LDW)", color: "bg-bppr" }, { name: "BPPR AAdvantage MC Black", perk: "MasterRental primary coverage up to $75k", color: "bg-bppr" } ],
    discount:  [ { name: "AMEX Schwab Platinum", perk: "Hertz President's Circle Â· Avis & National elite status", color: "bg-schwab" }, { name: "Citi AAdvantage Executive", perk: "Avis/Budget discounts Â· Up to $120 back", color: "bg-aa" } ],
    cashback:  [ { name: "Citi Costco Anywhere Visa", perk: "3% cash back on travel & rentals", color: "bg-costco" }, { name: "OnePay", perk: "1.5% flat cash back", color: "bg-onepay" } ]
  };

  const allCategories = [
    { name: "Auto & Transport:Car Insurance", emoji: "ğŸš—", type: "default" },
    { name: "Auto & Transport:Gas & Fuel", emoji: "â›½", type: "gas" },
    { name: "Auto & Transport:Parking", emoji: "ğŸ…¿ï¸", type: "default" },
    { name: "Auto & Transport:Registration (Other)", emoji: "ğŸš—", type: "default" },
    { name: "Auto & Transport:Registration Fees", emoji: "ğŸš—", type: "default" },
    { name: "Auto & Transport:Rideshare", emoji: "ğŸš•", type: "travel_other" },
    { name: "Auto & Transport:Service & Parts", emoji: "ğŸ”§", type: "default" },
    { name: "Auto & Transport:Tolls", emoji: "ğŸ›£ï¸", type: "default" },
    { name: "Cash & ATM:Cash & ATM", emoji: "ğŸ§", type: "default" },
    { name: "Dining & Drinks:Bars", emoji: "ğŸ»", type: "dining" },
    { name: "Dining & Drinks:Coffee Shops", emoji: "â˜•", type: "dining" },
    { name: "Dining & Drinks:Dining & Drinks (Other)", emoji: "ğŸ½ï¸", type: "dining" },
    { name: "Dining & Drinks:Fast Food", emoji: "ğŸ”", type: "fast_food" },
    { name: "Dining & Drinks:Food Delivery", emoji: "ğŸ¥¡", type: "dining" },
    { name: "Dining & Drinks:Restaurants", emoji: "ğŸ½ï¸", type: "dining" },
    { name: "Education:Software", emoji: "ğŸ“", type: "default" },
    { name: "Entertainment:Entertainment", emoji: "ğŸŸï¸", type: "default" },
    { name: "Fees & Charges:ATM Fee", emoji: "ğŸ’¸", type: "default" },
    { name: "Fees & Charges:Fees & Charges (Other)", emoji: "ğŸ’¸", type: "default" },
    { name: "Fees & Charges:Finance Charge", emoji: "ğŸ’¸", type: "default" },
    { name: "Fees & Charges:Government Payments", emoji: "ğŸ›ï¸", type: "default" },
    { name: "Fees & Charges:Late Fee", emoji: "ğŸ’¸", type: "default" },
    { name: "Fees & Charges:Service Fee", emoji: "ğŸ’¸", type: "default" },
    { name: "Financial:Financial (Other)", emoji: "ğŸ¦", type: "default" },
    { name: "Financial:Financial Advisor", emoji: "ğŸ“ˆ", type: "default" },
    { name: "Financial:Life Insurance", emoji: "ğŸ›¡ï¸", type: "default" },
    { name: "Fitness:Gym", emoji: "ğŸ‹ï¸", type: "gym" },
    { name: "Gifts:Gifts", emoji: "ğŸ", type: "default" },
    { name: "Groceries:Groceries", emoji: "ğŸ›’", type: "groceries" },
    { name: "Health:Dentist", emoji: "ğŸ¦·", type: "default" },
    { name: "Health:Doctor", emoji: "ğŸ‘¨â€âš•ï¸", type: "default" },
    { name: "Health:Eyecare", emoji: "ğŸ‘ï¸", type: "default" },
    { name: "Health:Health (Other)", emoji: "âš•ï¸", type: "default" },
    { name: "Health:Health Insurance", emoji: "ğŸ›¡ï¸", type: "default" },
    { name: "Health:Laboratory", emoji: "ğŸ”¬", type: "default" },
    { name: "Health:Pharmacy", emoji: "ğŸ’Š", type: "default" },
    { name: "Health:Vitamins & Supplements", emoji: "ğŸ’Š", type: "default" },
    { name: "Home:Furnishings", emoji: "ğŸ›‹ï¸", type: "default" },
    { name: "Home:Home Improvement", emoji: "ğŸ”¨", type: "default" },
    { name: "Home:Home Insurance", emoji: "ğŸ›¡ï¸", type: "default" },
    { name: "Home:Home Services", emoji: "ğŸ§¹", type: "default" },
    { name: "Home:Landscape", emoji: "ğŸŒ³", type: "default" },
    { name: "Home:Mortgage", emoji: "ğŸ ", type: "default" },
    { name: "Home:Repairs & Maintenance", emoji: "ğŸ”§", type: "default" },
    { name: "Kids:Allowance", emoji: "ğŸ‘¶", type: "default" },
    { name: "Kids:Baby Supplies", emoji: "ğŸ¼", type: "default" },
    { name: "Kids:Kids Health Insurance", emoji: "ğŸ›¡ï¸", type: "default" },
    { name: "Legal:Lawyer Fees", emoji: "âš–ï¸", type: "default" },
    { name: "Legal:Legal (Other)", emoji: "âš–ï¸", type: "default" },
    { name: "Legal:Parents Allowance", emoji: "ğŸ‘µ", type: "default" },
    { name: "Loans:Loans", emoji: "ğŸ’³", type: "default" },
    { name: "Office:Generator Fuel", emoji: "â›½", type: "gas" },
    { name: "Office:Generator Maintenance", emoji: "ğŸ”§", type: "default" },
    { name: "Office:Office Music", emoji: "ğŸµ", type: "default" },
    { name: "Office:Programs & Software", emoji: "ğŸ’»", type: "default" },
    { name: "Office:Software Subscription", emoji: "ğŸ’»", type: "utilities" },
    { name: "Personal Care:Hair", emoji: "ğŸ’‡", type: "default" },
    { name: "Personal Care:Personal Care (Other)", emoji: "ğŸ’†", type: "default" },
    { name: "Personal Care:Shallowness", emoji: "ğŸ’…", type: "default" },
    { name: "Personal Care:Spa", emoji: "ğŸ§–", type: "default" },
    { name: "Pets:Pet Food & Supplies", emoji: "ğŸ¾", type: "default" },
    { name: "Pets:Pets (Other)", emoji: "ğŸ¾", type: "default" },
    { name: "Pets:Veterinary", emoji: "ğŸ©º", type: "default" },
    { name: "Shopping:Clothing", emoji: "ğŸ‘•", type: "default" },
    { name: "Shopping:Electronics", emoji: "ğŸ’»", type: "electronics" },
    { name: "Shopping:Hobbies", emoji: "ğŸ¨", type: "sporting_goods" },
    { name: "Shopping:Jewelry", emoji: "ğŸ’", type: "default" },
    { name: "Shopping:Shipping", emoji: "ğŸ“¦", type: "default" },
    { name: "Shopping:Shopping (Other)", emoji: "ğŸ›ï¸", type: "default" },
    { name: "Subscriptions:Subscriptions", emoji: "ğŸ“…", type: "utilities" },
    { name: "Taxes:Local Tax", emoji: "ğŸ§¾", type: "default" },
    { name: "Taxes:Property Tax", emoji: "ğŸ§¾", type: "default" },
    { name: "Taxes:State Tax", emoji: "ğŸ§¾", type: "default" },
    { name: "Taxes:Taxes (Other)", emoji: "ğŸ§¾", type: "default" },
    { name: "Travel:Airfare", emoji: "âœˆï¸", type: "travel_airfare" },
    { name: "Travel:Baggage Fee", emoji: "ğŸ§³", type: "travel_other" },
    { name: "Travel:Car Rental", emoji: "ğŸš—", type: "travel_car_rental" },
    { name: "Travel:Car Rental Fuel", emoji: "â›½", type: "gas" },
    { name: "Travel:Excursions & Tours", emoji: "ğŸ—ºï¸", type: "travel_other" },
    { name: "Travel:Hotels & Lodging", emoji: "ğŸ¨", type: "travel_hotel" },
    { name: "Travel:Restaurants - T", emoji: "ğŸ½ï¸", type: "dining" },
    { name: "Travel:Taxi - T", emoji: "ğŸš•", type: "travel_other" },
    { name: "Travel:Travel (Other)", emoji: "ğŸ§³", type: "travel_other" },
    { name: "Utilities:Cable TV", emoji: "ğŸ“º", type: "utilities" },
    { name: "Utilities:Cellular Service", emoji: "ğŸ“±", type: "utilities" },
    { name: "Utilities:Electricity", emoji: "ğŸ’¡", type: "utilities" },
    { name: "Utilities:Internet", emoji: "ğŸŒ", type: "utilities" },
    { name: "Utilities:Water", emoji: "ğŸ’§", type: "utilities" },
    { name: "Yachting:Port Entry & Customs Fees", emoji: "ğŸ›‚", type: "marina_fees" },
    { name: "Yachting:Marina Slip Fees", emoji: "âš“", type: "marina_fees" },
    { name: "Yachting:Diesel & Gasoline", emoji: "ğŸ›¥ï¸", type: "marina_fuel" },
    { name: "Yachting:Lodging (Hotels/Resorts)", emoji: "ğŸ¨", type: "travel_hotel" },
    { name: "Yachting:Groceries (Costco)", emoji: "ğŸ›’", type: "costco" },
    { name: "Yachting:Restaurants", emoji: "ğŸ½ï¸", type: "dining" }
  ];

  // Connectivity Badge Logic
  function updateOnlineStatus() {
    const badge = document.getElementById('status-text');
    const dot = document.querySelector('.status-dot');
    if (navigator.onLine) {
      badge.textContent = 'Online & Synced';
      dot.style.background = 'var(--success)';
      dot.style.boxShadow = '0 0 8px var(--success)';
    } else {
      badge.textContent = 'Offline Ready';
      dot.style.background = 'var(--warning)';
      dot.style.boxShadow = '0 0 8px var(--warning)';
    }
  }
  window.addEventListener('online', updateOnlineStatus);
  window.addEventListener('offline', updateOnlineStatus);
  updateOnlineStatus();

  // Monthly Reminder Logic (Shows during the first 7 days of the month)
  function checkMonthlyReminder() {
    const now = new Date();
    const monthKey = `${now.getFullYear()}-${now.getMonth()}`;
    if (now.getDate() <= 7 && localStorage.getItem('reminderDismissed') !== monthKey) {
      document.getElementById('monthly-reminder').style.display = 'flex';
    }
  }
  function dismissReminder() {
    const now = new Date();
    localStorage.setItem('reminderDismissed', `${now.getFullYear()}-${now.getMonth()}`);
    document.getElementById('monthly-reminder').style.display = 'none';
  }
  checkMonthlyReminder();

  // Quick-Tap Tiles
  const quickTilesMap = {
    'gas': 'Auto & Transport:Gas & Fuel',
    'dining': 'Dining & Drinks:Restaurants',
    'groceries': 'Groceries:Groceries',
    'travel': 'Travel:Airfare',
    'marina': 'Yachting:Diesel & Gasoline'
  };

  function triggerQuickTile(key) {
    const targetName = quickTilesMap[key];
    const index = allCategories.findIndex(c => c.name === targetName);
    if(index !== -1) {
      const item = allCategories[index];
      const cleanName = item.name.split(':')[1] || item.name;
      document.getElementById('category-search').value = `${item.emoji} ${cleanName}`;
      handleSelection(index);
    }
  }

  // Dropdown UI Logic
  const searchInput = document.getElementById('category-search');
  const optionsList = document.getElementById('custom-options-list');

  const groupedCategories = {};
  allCategories.forEach((cat, index) => {
    const [group, ...rest] = cat.name.split(':');
    const item = rest.join(':').trim() || group.trim();
    if (!groupedCategories[group]) groupedCategories[group] = [];
    groupedCategories[group].push({ ...cat, cleanName: item, originalIndex: index });
  });

  Object.keys(groupedCategories).forEach(groupName => {
    const groupDiv = document.createElement('div');
    groupDiv.className = 'option-group';
    groupDiv.textContent = groupName;
    optionsList.appendChild(groupDiv);

    groupedCategories[groupName].forEach(item => {
      const itemDiv = document.createElement('div');
      itemDiv.className = 'option-item';
      itemDiv.innerHTML = `<span class="emoji">${item.emoji}</span>${item.cleanName}`;
      itemDiv.setAttribute('data-search', `${groupName} ${item.cleanName}`.toLowerCase());
      itemDiv.addEventListener('click', e => {
        e.stopPropagation();
        searchInput.value = `${item.emoji}  ${item.cleanName}`;
        optionsList.classList.remove('show');
        handleSelection(item.originalIndex);
      });
      optionsList.appendChild(itemDiv);
    });
  });

  function filterOptions(term) {
    term = term.toLowerCase();
    let currentGroup = null, groupHasVisible = false;
    Array.from(optionsList.children).forEach(el => {
      if (el.classList.contains('option-group')) {
        if (currentGroup) currentGroup.style.display = groupHasVisible ? '' : 'none';
        currentGroup = el; groupHasVisible = false;
      } else {
        const match = (el.getAttribute('data-search') || '').includes(term);
        el.style.display = match ? '' : 'none';
        if (match) groupHasVisible = true;
      }
    });
    if (currentGroup) currentGroup.style.display = groupHasVisible ? '' : 'none';
  }

  searchInput.addEventListener('input', e => filterOptions(e.target.value));
  searchInput.addEventListener('click', e => {
    e.stopPropagation();
    optionsList.classList.add('show');
    filterOptions(searchInput.value);
  });
  document.addEventListener('click', e => {
    if (!optionsList.contains(e.target) && e.target !== searchInput)
      optionsList.classList.remove('show');
  });

  // Selection & Rendering
  let currentActiveRule = null;

  function handleSelection(index) {
    const item = allCategories[index];
    currentActiveRule = rulesMap[item.type] || rulesMap.default;

    document.getElementById('note-area').style.display = 'none';
    document.getElementById('recommendation-area').style.display = 'none';
    document.getElementById('sub-question').style.display = 'none';

    if (currentActiveRule.requiresSubChoice) {
      document.getElementById('sub-question').style.display = 'block';
    } else {
      if (currentActiveRule.note) {
        document.getElementById('note-area').textContent = currentActiveRule.note;
        document.getElementById('note-area').style.display = 'block';
      }
      renderCards(currentActiveRule.cards);
    }
  }

  function resolveSub(choice) {
    document.getElementById('sub-question').style.display = 'none';
    renderCards(carRentalSubChoices[choice]);
  }

  function renderCards(cards) {
    const container = document.getElementById('cards-container');
    container.innerHTML = '';
    
    // Filter based on user wallet
    const activeCards = cards.filter(c => userWallet[c.name] !== false);

    if (activeCards.length === 0) {
      container.innerHTML = `<div class="no-cards-msg">No cards in your active wallet match this category.<br>Enable more cards in Settings.</div>`;
    } else {
      activeCards.forEach((c, i) => {
        const div = document.createElement('div');
        div.className = `cc-card ${c.color}`;
        div.style.animationDelay = `${i * 80}ms`;
        div.style.animation = 'fadeIn 0.35s ease both';
        div.innerHTML = `
          <div class="card-rank">${i + 1}</div>
          <div class="card-name">${c.name}</div>
          <div class="card-perk">${c.perk}</div>
        `;
        container.appendChild(div);
      });
    }
    document.getElementById('recommendation-area').style.display = 'block';
  }

  // Settings Logic
  function openSettings() {
    const container = document.getElementById('wallet-list-container');
    container.innerHTML = '';
    
    knownCards.forEach(card => {
      const isChecked = userWallet[card] !== false;
      const div = document.createElement('div');
      div.className = 'wallet-item';
      div.innerHTML = `
        <label for="toggle-${card}">${card}</label>
        <label class="switch">
          <input type="checkbox" id="toggle-${card}" ${isChecked ? 'checked' : ''}>
          <span class="slider"></span>
        </label>
      `;
      container.appendChild(div);
    });
    
    document.getElementById('settings-modal').classList.add('active');
  }

  function closeSettings() {
    document.getElementById('settings-modal').classList.remove('active');
  }

  function saveSettings() {
    knownCards.forEach(card => {
      const toggle = document.getElementById(`toggle-${card}`);
      if (toggle) {
        userWallet[card] = toggle.checked;
      }
    });
    localStorage.setItem('userWallet', JSON.stringify(userWallet));
    closeSettings();
    
    // Re-render if a category is already selected
    if (document.getElementById('recommendation-area').style.display === 'block') {
        const query = document.getElementById('category-search').value.toLowerCase();
        if(query) {
            // Simply re-trigger the input search simulation or if Subquestion was bypassed
            if(currentActiveRule && !currentActiveRule.requiresSubChoice) {
               renderCards(currentActiveRule.cards);
            }
        }
    }
  }

  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js').catch(() => {});
  }
</script>
</body>
</html>
